<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Chatbot MiauMarket</title>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 0 auto; padding: 20px; }
        .chat-container { border: 1px solid #ddd; border-radius: 8px; height: 400px; overflow-y: auto; padding: 10px; margin: 10px 0; background-color: #f9f9f9; }
        .message { margin: 10px 0; padding: 8px 12px; border-radius: 12px; max-width: 70%; }
        .user-message { background-color: #007bff; color: white; margin-left: auto; text-align: right; }
        .bot-message { background-color: #e9ecef; color: #333; margin-right: auto; }
        .input-area { display: flex; gap: 10px; }
        .input-area input { flex: 1; padding: 10px; border: 1px solid #ddd; border-radius: 4px; }
        .input-area button { padding: 10px 20px; background-color: #007bff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .input-area button:disabled { background-color: #ccc; cursor: not-allowed; }
        .loading { font-style: italic; color: #666; }
    </style>
</head>
<body>
    <h1>üêæ Test Chatbot MiauMarket</h1>
    <div id="chatContainer" class="chat-container"></div>
    <div class="input-area">
        <input type="text" id="messageInput" placeholder="Escribe tu mensaje aqu√≠..." />
        <button id="sendButton" onclick="sendMessage()">Enviar</button>
    </div>

    <script>
        const API_URL = 'http://localhost:8000/api/usuarios/chatbot/';
        let isLoading = false;

        // Agregar mensaje de bienvenida al cargar
        window.onload = function() {
            addBotMessage('¬°Hola! üêæ Bienvenido a MiauMarket.\nSoy tu asistente para todo lo que tu perro necesita üêï\n\nPuedo ayudarte con:\n‚Ä¢ Productos recomendados\n‚Ä¢ Cuidado y alimentaci√≥n\n‚Ä¢ Comportamiento y razas\n\n¬°Cu√©ntame sobre tu mascota y empecemos! ü¶¥');
        };

        // Funci√≥n para enviar mensaje
        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || isLoading) return;

            // Agregar mensaje del usuario
            addUserMessage(message);
            input.value = '';
            
            // Mostrar loading
            isLoading = true;
            document.getElementById('sendButton').disabled = true;
            addLoadingMessage();

            try {
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ message: message })
                });

                removeLoadingMessage();
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();

                if (data.success) {
                    const botMessage = data.response || data.recommendations || 'Lo siento, no pude generar una respuesta.';
                    addBotMessage(botMessage);
                } else {
                    addBotMessage(`Error: ${data.error || 'No se pudo procesar tu mensaje'}`);
                }
            } catch (error) {
                removeLoadingMessage();
                console.error('Error:', error);
                addBotMessage('‚ùå Error de conexi√≥n. Aseg√∫rate de que el servidor Django est√© ejecut√°ndose en http://localhost:8000');
            } finally {
                isLoading = false;
                document.getElementById('sendButton').disabled = false;
            }
        }

        // Funci√≥n para agregar mensaje del usuario
        function addUserMessage(text) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message user-message';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Funci√≥n para agregar mensaje del bot
        function addBotMessage(text) {
            const container = document.getElementById('chatContainer');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message bot-message';
            messageDiv.style.whiteSpace = 'pre-line';
            messageDiv.textContent = text;
            container.appendChild(messageDiv);
            container.scrollTop = container.scrollHeight;
        }

        // Funciones para loading
        function addLoadingMessage() {
            const container = document.getElementById('chatContainer');
            const loadingDiv = document.createElement('div');
            loadingDiv.id = 'loadingMessage';
            loadingDiv.className = 'message bot-message loading';
            loadingDiv.textContent = 'Escribiendo...';
            container.appendChild(loadingDiv);
            container.scrollTop = container.scrollHeight;
        }

        function removeLoadingMessage() {
            const loading = document.getElementById('loadingMessage');
            if (loading) loading.remove();
        }

        // Permitir enviar con Enter
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
    </script>
</body>
</html>