<div class="admin-container">
  <div class="admin-header">
    <h1>Panel de Administraci√≥n</h1>
    
    <!-- Tabs de navegaci√≥n -->
    <div class="admin-tabs">
      <button 
        class="tab-btn" 
        [class.active]="activeTab() === 'productos'"
        (click)="activeTab.set('productos')"
      >
        üì¶ Productos
      </button>
      <button 
        class="tab-btn" 
        [class.active]="activeTab() === 'pedidos'"
        (click)="activeTab.set('pedidos'); loadOrders()"
      >
        üõí Pedidos
      </button>
      <a 
        class="tab-btn dashboard-btn" 
        routerLink="/dashboard"
      >
        üìä Dashboard
      </a>
    </div>
  </div>

  <!-- Mensajes -->
  <div class="alert alert-success" *ngIf="successMessage()">
    {{ successMessage() }}
  </div>
  <div class="alert alert-error" *ngIf="errorMessage()" (click)="errorMessage.set('')" style="cursor: pointer;">
    {{ errorMessage() }} (Haz clic para cerrar)
  </div>

  <!-- PESTA√ëA DE PRODUCTOS -->
  <div *ngIf="activeTab() === 'productos'">
    <div class="section-header">
      <button class="btn btn-primary" (click)="openForm()" *ngIf="!showForm()">
        + Agregar Producto
      </button>
    </div>

  <!-- Formulario -->
  <div class="admin-form" *ngIf="showForm()">
    <h2>{{ editingId() ? 'Editar Producto' : 'Nuevo Producto' }}</h2>
    
    <div class="form-group">
      <label>T√≠tulo</label>
      <input 
        class="input"
        type="text" 
        [(ngModel)]="newProduct().Titulo"
        placeholder="Nombre del producto"
      />
    </div>

    <div class="form-group">
      <label>Descripci√≥n</label>
      <textarea 
        class="input"
        [(ngModel)]="newProduct().Descripcion"
        placeholder="Descripci√≥n del producto"
        rows="4"
      ></textarea>
    </div>

    <div class="form-group">
      <label>Categor√≠a</label>
      <select 
        class="input"
        [(ngModel)]="newProduct().Categoria"
      >
        <option value="">Selecciona una categor√≠a</option>
        <option *ngFor="let cat of categorias" [value]="cat">
          {{ cat }}
        </option>
      </select>
    </div>

    <div class="form-row">
      <div class="form-group">
        <label>Precio</label>
        <input 
          class="input"
          type="number" 
          [(ngModel)]="newProduct().Precio"
          placeholder="Precio"
          step="0.01"
          min="0"
        />
      </div>

      <div class="form-group">
        <label>Stock</label>
        <input 
          class="input"
          type="number" 
          [(ngModel)]="newProduct().Stock"
          placeholder="Stock"
          min="0"
        />
      </div>
    </div>

    <div class="form-group">
      <label>Fecha de Caducidad *</label>
      <input 
        class="input"
        type="date" 
        [(ngModel)]="newProduct().Fecha_Caducidad"
        required
      />
    </div>

    <div class="form-group">
      <label>Imagen</label>
      <div class="image-upload">
        <input 
          class="input"
          type="file"
          accept="image/*"
          (change)="onImageSelect($event)"
          #imageInput
        />
        <div class="image-preview" *ngIf="imagePreviewUrl() || (newProduct().Imagen && typeof newProduct().Imagen === 'string')">
          <img 
            [src]="imagePreviewUrl() || newProduct().Imagen" 
            alt="Preview"
          />
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button class="btn btn-primary" (click)="saveProduct()" [disabled]="loading()">
        {{ loading() ? 'Guardando...' : (editingId() ? 'Actualizar' : 'Crear') }}
      </button>
      <button class="btn btn-ghost" (click)="closeForm()">Cancelar</button>
    </div>
  </div>

  <!-- Lista de productos -->
  <div class="products-grid" *ngIf="!showForm()">
    <div *ngIf="loading() && products().length === 0" class="loading">
      Cargando productos...
    </div>

    <div *ngIf="products().length === 0 && !loading()" class="empty-state">
      <p>No hay productos registrados</p>
    </div>

    <div class="product-card" *ngFor="let product of products()">
      <div class="product-image">
        <img 
          *ngIf="product.Imagen" 
          [src]="product.Imagen" 
          alt="{{ product.Titulo }}"
        />
        <div *ngIf="!product.Imagen" class="no-image">
          üì¶
        </div>
      </div>

      <div class="product-info">
        <h3>{{ product.Titulo }}</h3>
        <p class="description">{{ product.Descripcion }}</p>
        <p class="category">{{ product.Categoria }}</p>
        <p class="expiry-date">Caduca: {{ product.Fecha_Caducidad }}</p>
        <div class="product-stats">
          <span class="price">COP {{ product.Precio | number:'1.0-0' }}</span>
          <span class="stock">Stock: {{ product.Stock }}</span>
        </div>
      </div>

      <div class="product-actions">
        <button class="btn btn-secondary" (click)="openForm(product)">
          ‚úèÔ∏è Editar
        </button>
        <button class="btn btn-danger" (click)="deleteProduct(product.Id_Products); $event.preventDefault()">
          üóëÔ∏è Eliminar
        </button>
      </div>
    </div>
  </div>
  </div>

  <!-- PESTA√ëA DE PEDIDOS -->
  <div *ngIf="activeTab() === 'pedidos'" class="orders-section">
    <h2>Gesti√≥n de Pedidos</h2>

    <div *ngIf="loadingOrders()" class="loading">
      Cargando pedidos...
    </div>

    <div *ngIf="orders().length === 0 && !loadingOrders()" class="empty-state">
      <p>No hay pedidos registrados</p>
    </div>

    <div class="orders-list">
      <div class="order-card" *ngFor="let order of orders()">
        <div class="order-header">
          <div class="order-info">
            <h3>Pedido #{{ order.Id_Factura }}</h3>
            <p class="order-date">{{ order.Fecha }}</p>
          </div>
          <div class="order-status">
            <span 
              class="status-badge" 
              [class.status-pendiente]="order.Estado === 'Pendiente'"
              [class.status-enviado]="order.Estado === 'Enviado'"
              [class.status-entregado]="order.Estado === 'Entregado'"
              [class.status-devuelto]="order.Estado === 'Devuelto'"
            >
              {{ order.Estado }}
            </span>
          </div>
        </div>

        <div class="order-details">
          <div class="detail-row">
            <strong>Cliente:</strong> {{ order.usuario_nombre }} ({{ order.usuario_email }})
          </div>
          <div class="detail-row">
            <strong>Tel√©fono:</strong> {{ order.Telefono_Envio || 'No especificado' }}
          </div>
          <div class="detail-row">
            <strong>Direcci√≥n:</strong> {{ order.Direccion_Envio || 'No especificada' }}
          </div>
          <div class="detail-row">
            <strong>Total:</strong> <span class="order-total">COP {{ order.Total | number:'1.0-0' }}</span>
          </div>
          <div class="detail-row">
            <strong>M√©todo de pago:</strong> {{ order.Metodo_Pago }}
          </div>
        </div>

        <!-- Productos del pedido -->
        <div class="order-products" *ngIf="order.productos && order.productos.length > 0">
          <h4>Productos:</h4>
          <div class="product-list">
            <div class="product-item" *ngFor="let producto of order.productos">
              <div class="product-info">
                <strong>{{ producto.Titulo }}</strong>
                <span class="product-quantity">Cantidad: {{ producto.Cantidad }}</span>
              </div>
              <div class="product-prices">
                <span class="product-unit-price">COP {{ producto.Precio_Unitario | number:'1.0-0' }} c/u</span>
                <strong class="product-subtotal">COP {{ producto.Subtotal | number:'1.0-0' }}</strong>
              </div>
            </div>
          </div>
        </div>

        <div class="order-actions">
          <label for="estado-{{ order.Id_Factura }}"><strong>Cambiar estado:</strong></label>
          <select 
            id="estado-{{ order.Id_Factura }}"
            class="status-select"
            [value]="order.Estado"
            (change)="updateOrderStatus(order.Id_Factura, $any($event.target).value)"
          >
            <option value="Pendiente">Pendiente</option>
            <option value="Enviado">Enviado</option>
            <option value="Entregado">Entregado</option>
            <option value="Devuelto">Devuelto</option>
          </select>
        </div>
      </div>
    </div>
  </div>
</div>
